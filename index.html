<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Royal Assign Terminal</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#800000">
    <link rel="apple-touch-icon" href="icon-192.png">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    
    <style>
        :root { 
            --maroon: #800000; 
            --gold: #D4AF37; 
            --cream: #F5F5DC;
            --white: #FFFFFF; 
            --dark: #1a1a1a; 
            --paper: #fffdf0;
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--cream); margin: 0; padding: 0; color: #333; height: 100vh; display: flex; flex-direction: column; }

        header { 
            background: var(--maroon); color: white; padding: 15px; 
            display: flex; justify-content: space-between; align-items: center; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .app-title { font-weight: 900; letter-spacing: 1px; font-size: 18px; }
        .btn-logout { background: none; border: none; color: white; font-size: 22px; cursor: pointer; }

        #connect-screen {
            flex: 1; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; 
            text-align: center; padding: 20px;
        }
        
        .btn-pair {
            width: 180px; height: 180px; border-radius: 50%;
            background: var(--white); border: 4px solid var(--maroon);
            color: var(--maroon); font-size: 18px; font-weight: 900;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            box-shadow: 0 10px 30px rgba(128, 0, 0, 0.2); cursor: pointer;
            transition: transform 0.2s;
        }
        .btn-pair i { font-size: 50px; margin-bottom: 10px; }
        .btn-pair:active { transform: scale(0.95); background: var(--maroon); color: var(--gold); border-color: var(--gold); }

        #work-screen {
            flex: 1; padding: 30px 20px; display: none; 
            flex-direction: column; gap: 25px;
        }

        .input-group { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .lbl { display: block; font-weight: bold; color: var(--maroon); margin-bottom: 8px; font-size: 14px; }
        .inp { width: 100%; border: none; border-bottom: 2px solid #ccc; padding: 10px 5px; font-size: 22px; font-weight: 900; outline: none; color: #333; background: transparent; }
        .inp:focus { border-color: var(--gold); }

        .btn-action {
            width: 100%; padding: 18px; border-radius: 12px; border: none;
            background: var(--maroon); color: var(--gold);
            font-size: 20px; font-weight: 900; cursor: pointer;
            box-shadow: 0 5px 15px rgba(128,0,0,0.3); margin-top: 20px;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn-action:disabled { background: #999; color: #eee; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 6000; align-items: center; justify-content: center; }
        .modal-content { background: var(--paper); width: 90%; max-width: 380px; padding: 20px; border-radius: 10px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); display: flex; flex-direction: column; max-height: 85vh; }
        
        .receipt-preview {
            background: white; padding: 15px; border: 1px dashed #ccc; 
            font-family: 'Courier New', monospace; font-size: 13px; 
            overflow-y: auto; margin-bottom: 20px; flex: 1;
            white-space: pre-wrap; line-height: 1.2; color: black;
        }
        
        .raw-debug {
            font-size: 10px; color: #666; background: #eee; padding: 5px; 
            border-radius: 4px; margin-bottom: 10px; overflow-wrap: break-word;
            display: none; 
        }

        .modal-btns { display: flex; gap: 10px; }
        .btn-confirm { flex: 1; background: var(--maroon); color: white; border: none; padding: 15px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-cancel { flex: 1; background: #ddd; color: #333; border: none; padding: 15px; border-radius: 8px; font-weight: bold; cursor: pointer; }

        #login-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--dark); z-index: 5000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .login-card { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 350px; text-align: center; }
        .inp-login { width: 100%; padding: 15px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; }
        .btn-login { background: var(--maroon); color: white; border: none; width: 100%; padding: 15px; border-radius: 10px; font-weight: 900; font-size: 16px; cursor: pointer; }

        #settings-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 7000; align-items: center; justify-content: center; }
        .set-box { background: white; padding: 25px; width: 85%; border-radius: 12px; }

    </style>
</head>
<body>

    <div id="login-view">
        <div style="position:fixed; top:20px; right:20px; color:white; cursor:pointer;" onclick="openSettings()">⚙️</div>
        <div class="login-card">
            <h2 style="color:var(--maroon);">ROYAL ASSIGN</h2>
            <input type="email" id="login-email" class="inp-login" placeholder="Email">
            <input type="password" id="login-pass" class="inp-login" placeholder="Password">
            <button class="btn-login" onclick="handleLogin()">LOGIN</button>
        </div>
    </div>

    <div id="settings-modal">
        <div class="set-box">
            <h3>Config</h3>
            <input type="text" id="conf-url" class="inp-login" placeholder="URL">
            <input type="text" id="conf-key" class="inp-login" placeholder="Key">
            <button class="btn-login" onclick="saveConfig()">SAVE</button>
            <button class="btn-login" style="background:#ccc; color:black; margin-top:10px;" onclick="document.getElementById('settings-modal').style.display='none'">CLOSE</button>
        </div>
    </div>

    <div id="preview-modal" class="modal">
        <div class="modal-content">
            <h3 style="margin-top:0; text-align:center; color:var(--maroon);">CONFIRM RECEIPT</h3>
            <div id="receipt-container" class="receipt-preview"></div>
            <div id="raw-debug" class="raw-debug"></div>
            
            <div class="modal-btns">
                <button class="btn-cancel" onclick="closePreview()">CANCEL</button>
                <button class="btn-confirm" onclick="confirmAndPrint()">PRINT</button>
            </div>
        </div>
    </div>

    <header>
        <div class="app-title">ALTERATION ASSIGN</div>
        <button class="btn-logout" onclick="logout()"><i class="ri-logout-box-r-line"></i></button>
    </header>

    <div id="connect-screen">
        <button class="btn-pair" onclick="connectPrinter()">
            <i class="ri-bluetooth-connect-line"></i>
            <div>PAIR<br>PRINTER</div>
        </button>
        <p style="margin-top:20px; color:#666; font-weight:bold;">Tap to Connect Thermal Printer</p>
    </div>

    <div id="work-screen">
        <div class="input-group">
            <label class="lbl">ENTER BILL NUMBER</label>
            <input type="number" id="bill-no" class="inp" placeholder="e.g. 501">
        </div>
        <div class="input-group">
            <label class="lbl">SELECT DELIVERY DATE</label>
            <input type="date" id="del-date" class="inp">
        </div>
        <button id="action-btn" class="btn-action" onclick="fetchAndPreview()">
            <i class="ri-file-search-line"></i> ASSIGN & PRINT
        </button>
        <div id="status-msg" style="text-align:center; color:green; font-weight:bold; margin-top:10px;"></div>
    </div>

    <script>
        let supabaseClient;
        let printCharacteristic = null;
        let printerDevice = null;
        let currentBillData = null;

        // PWA INSTALL SCRIPT
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').then(() => console.log("SW Registered"));
            });
        }

        window.onload = function() {
            const u = localStorage.getItem('rs-url');
            const k = localStorage.getItem('rs-key');
            if(u && k) { supabaseClient = supabase.createClient(u, k); checkSession(); }
            document.getElementById('del-date').valueAsDate = new Date();
        };

        function openSettings() { if(prompt("Code:")==='5563990') document.getElementById('settings-modal').style.display='flex'; }
        function saveConfig() { localStorage.setItem('rs-url', document.getElementById('conf-url').value); localStorage.setItem('rs-key', document.getElementById('conf-key').value); location.reload(); }
        async function handleLogin() { const e=document.getElementById('login-email').value, p=document.getElementById('login-pass').value; const {error}=await supabaseClient.auth.signInWithPassword({email:e, password:p}); if(!error) checkSession(); else alert(error.message); }
        async function checkSession() { const {data}=await supabaseClient.auth.getSession(); if(data.session){ document.getElementById('login-view').style.display='none'; } }
        async function logout() { await supabaseClient.auth.signOut(); location.reload(); }

        async function connectPrinter() {
            try {
                printerDevice = await navigator.bluetooth.requestDevice({ filters: [{ services: ['000018f0-0000-1000-8000-00805f9b34fb'] }] });
                const server = await printerDevice.gatt.connect();
                const service = await server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
                printCharacteristic = await service.getCharacteristic('00002af1-0000-1000-8000-00805f9b34fb');
                document.getElementById('connect-screen').style.display = 'none';
                document.getElementById('work-screen').style.display = 'flex';
            } catch(e) { alert("Connection Failed: " + e.message); }
        }

        async function fetchAndPreview() {
            const billNo = document.getElementById('bill-no').value.trim();
            const dateStr = document.getElementById('del-date').value;

            if(!billNo || !dateStr) return alert("Please fill Bill No and Date");
            if(!printCharacteristic) return alert("Printer Disconnected! Reload.");

            const btn = document.getElementById('action-btn');
            btn.disabled = true; btn.innerText = "FETCHING...";

            try {
                const { data, error } = await supabaseClient.from('bills').select('*').eq('bill_number', billNo).single();
                if(error || !data) throw new Error("Bill Not Found!");

                currentBillData = data; 
                
                const previewHtml = generateReceiptText(data, billNo, dateStr, true);
                document.getElementById('receipt-container').innerHTML = previewHtml;

                let m = data.measurements;
                if(typeof m === 'object' && m !== null) m = JSON.stringify(m);
                document.getElementById('raw-debug').innerText = "Raw DB Data: " + m;
                document.getElementById('raw-debug').style.display = 'block';

                document.getElementById('preview-modal').style.display = 'flex';
                btn.disabled = false; btn.innerHTML = '<i class="ri-file-search-line"></i> ASSIGN & PRINT';

            } catch(e) {
                alert("Error: " + e.message);
                btn.disabled = false; btn.innerHTML = '<i class="ri-file-search-line"></i> ASSIGN & PRINT';
            }
        }

        function closePreview() { document.getElementById('preview-modal').style.display = 'none'; }

        async function confirmAndPrint() {
            closePreview();
            const btn = document.getElementById('action-btn');
            btn.disabled = true; btn.innerText = "PRINTING...";

            const billNo = document.getElementById('bill-no').value.trim();
            const dateStr = document.getElementById('del-date').value;

            try {
                await supabaseClient.from('bills').update({ delivery_date: dateStr }).eq('id', currentBillData.id);
                await supabaseClient.from('alteration_tickets').upsert([{ 
                    bill_number: billNo, delivery_date: dateStr, status: 'PENDING', updated_at: new Date().toISOString() 
                }], { onConflict: 'bill_number' });

                const rawCmds = generateReceiptText(currentBillData, billNo, dateStr, false);
                const encoder = new TextEncoder();
                await printCharacteristic.writeValue(encoder.encode(rawCmds));

                document.getElementById('status-msg').innerText = `✅ Bill #${billNo} Done!`;
                document.getElementById('bill-no').value = '';
                btn.disabled = false; btn.innerHTML = '<i class="ri-file-search-line"></i> ASSIGN & PRINT';
                setTimeout(() => document.getElementById('status-msg').innerText = '', 3000);

            } catch(e) {
                alert("Printing Error: " + e.message);
                btn.disabled = false; btn.innerHTML = '<i class="ri-file-search-line"></i> ASSIGN & PRINT';
            }
        }

        function generateReceiptText(billData, billNo, dateStr, isHtml) {
            let displayDate = dateStr;
            if(dateStr.length === 10) {
                const parts = dateStr.split('-'); 
                displayDate = `${parts[2]}-${parts[1]}-${parts[0].slice(-2)}`;
            }
            
            const now = new Date();
            const dateDisplay = `${String(now.getDate()).padStart(2,'0')}/${String(now.getMonth()+1).padStart(2,'0')}`;
            const timeDisplay = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
            const headerTimeStr = `${dateDisplay} ${timeDisplay}`;

            const NL = isHtml ? "<br>" : "\n";
            const LINE = isHtml ? "--------------------------------<br>" : "--------------------------------\n";
            const B_ON = isHtml ? "<b>" : "\x1B\x45\x01";
            const B_OFF = isHtml ? "</b>" : "\x1B\x45\x00";
            const CEN = isHtml ? "<div style='text-align:center'>" : "\x1B\x61\x01";
            const LEFT = isHtml ? "<div style='text-align:left'>" : "\x1B\x61\x00";
            const END_DIV = isHtml ? "</div>" : "";
            const BIG = isHtml ? "<span style='font-size:1.5em; font-weight:bold'>" : "\x1D\x21\x11";
            const NORM = isHtml ? "</span>" : "\x1D\x21\x00";
            const CUT = isHtml ? "" : "\x1D\x56\x41\x00";
            const INIT = isHtml ? "" : "\x1B\x40";

            let m = billData.measurements;
            let attempt = 0;
            while(typeof m === 'string' && attempt < 3) {
                try {
                    if(m.startsWith('"') && m.endsWith('"')) m = m.slice(1, -1).replace(/\\"/g, '"');
                    m = JSON.parse(m);
                } catch(e) { break; }
                attempt++;
            }
            if (!m || typeof m !== 'object') m = {};

            let flatM = { ...m };
            if(m.upper && typeof m.upper === 'object') flatM = { ...flatM, ...m.upper };
            if(m.lower && typeof m.lower === 'object') flatM = { ...flatM, ...m.lower };

            const getVal = (key) => {
                const aliases = {
                    'length': ['Length', 'length', 'len', 'Lenth', 'lenth'], 
                    'pent length': ['Pent Length', 'pent length', 'Pent L', 'pent l'],
                    'baju': ['Baju Length', 'baju length', 'Sleeve', 'sleeve'],
                    'baju moti': ['Baju Mori', 'baju mori', 'Mori', 'mori'],
                    'hip': ['Hip', 'Hips', 'hip', 'hips'],
                    'inner length': ['Inner Length', 'inner length', 'Lower Length', 'lower length']
                };
                const search = [key, ...(aliases[key.toLowerCase()] || [])];
                
                for(let k of search) {
                    if(flatM[k] && flatM[k] !== '-') return flatM[k];
                    const fKey = Object.keys(flatM).find(o => o.toLowerCase() === k.toLowerCase());
                    if(fKey && flatM[fKey] && typeof flatM[fKey] !== 'object' && flatM[fKey] !== '-') return flatM[fKey];
                }
                return "-";
            };

            const displayMap = {
                "Upper Length": "Upper L",
                "Inner Length": "Inner L",
                "Baju Length": "Baju L",
                "Baju Mori": "Baju M",
                "Pent Length": "Pent L",
                "Byseps": "Biceps"
            };

            let txt = INIT;
            txt += LEFT + "ROYAL SHERWANI   " + headerTimeStr + NL;
            txt += LINE;
            txt += LEFT + BIG + billNo + "     " + displayDate + NORM + NL;
            txt += LINE;

            txt += CEN + B_ON + "LOWER          UPPER" + B_OFF + END_DIV + NL;

            // CORRECTED KEYS as per last request
            const lowerKeys = ["Asan", "Kamar", "Hip", "Thai", "Ghutna", "Pindli", "Mori", "Pent Length", "Baju Mori", "Byseps"];
            const upperKeys = ["Pagdi", "Neck", "Chest", "Pet", "Hip", "Baju", "Length", "Upper Length", "Inner Length"];

            const maxRows = Math.max(lowerKeys.length, upperKeys.length);
            
            for(let i=0; i<maxRows; i++) {
                let leftCol = "", rightCol = "";
                
                if(i < lowerKeys.length) {
                    let val = getVal(lowerKeys[i]);
                    let label = displayMap[lowerKeys[i]] || lowerKeys[i];
                    if(label.length > 7) label = label.substring(0,7);
                    leftCol = `${label}:${val}`;
                }
                
                if(i < upperKeys.length) {
                    let val = getVal(upperKeys[i]);
                    let label = displayMap[upperKeys[i]] || upperKeys[i];
                    if(label.length > 7) label = label.substring(0,7);
                    rightCol = `${label}:${val}`;
                }

                if(isHtml) {
                    txt += `<div style="display:flex; justify-content:center; font-size:11px; gap:15px;">
                                <div style="width:120px; text-align:left;">${leftCol}</div>
                                <div style="width:120px; text-align:left;">${rightCol}</div>
                            </div>`;
                } else {
                    txt += leftCol.padEnd(16, " ") + "  " + rightCol + NL;
                }
            }

            txt += NL + NL + NL + NL + CUT;

            return txt;
        }

    </script>
</body>
</html>